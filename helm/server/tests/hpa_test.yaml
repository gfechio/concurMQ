suite: test hpa
templates:
  - hpa.yaml
tests:
  - it: should render nothing if not enabled
    set:
      autoscaling.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should pass
    set:
      global.labels.owner: platform
      autoscaling:
        enabled: true
        minReplicas: 3
        maxReplicas: 10
        metrics:
          - type: Resource
            resource:
              name: cpu
              targetAverageUtilization: 80
          - type: Resource
            resource:
              name: memory
              targetAverageUtilization: 80
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: HorizontalPodAutoscaler
      - isAPIVersion:
          of: autoscaling/v2beta1
      - matchRegex:
          path: metadata.name
          pattern: -beat-base$
      - equal:
          path: metadata.labels.owner
          value: platform
      - equal:
          path: spec.scaleTargetRef
          value:
            apiVersion: apps/v1
            kind: Deployment
            name: release-name-beat-base
      - equal:
          path: spec.minReplicas
          value: 3
      - equal:
          path: spec.maxReplicas
          value: 10
      - equal:
          path: spec.metrics
          value:
            - resource:
                name: cpu
                targetAverageUtilization: 80
              type: Resource
            - resource:
                name: memory
                targetAverageUtilization: 80
              type: Resource
